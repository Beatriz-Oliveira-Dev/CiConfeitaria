{% extends 'base.html' %}

{% block content %}
<section class="hero">
  <div class="hero-text">
    <p class="eyebrow">Cardápio da Casa</p>
    <h1>Inspire-se e adicione sabor ao seu dia!</h1>
    <p class="lead">Explore receitas doces com visual de vitrine, abra o card para ver ingredientes e modo de preparo.</p>
  </div>
  <div class="hero-art" aria-hidden="true">✨</div>
</section>

<section class="gallery">
  {% if recipes %}
  <div class="pin-grid">
    {% for recipe in recipes %}
      <article class="pin-card" tabindex="0"
        data-id="{{ recipe.id }}"
        data-title="{{ recipe.title }}"
        data-description="{{ recipe.description }}"
        data-image="{{ recipe.image_url or url_for('static', filename='placeholder.svg') }}"
        data-ingredients='{{ recipe.ingredients.split("\n")|tojson }}'
        data-instructions='{{ recipe.instructions.split("\n")|tojson }}'
        data-favorite="{{ 'true' if recipe.favorite else 'false' }}">
        <div class="pin-media">
          <img src="{{ recipe.image_url or url_for('static', filename='placeholder.svg') }}" alt="{{ recipe.title }}" loading="lazy">
          <button class="pin-fav {% if recipe.favorite %}is-favorite{% endif %}" type="button"
            aria-label="{{ 'Remover dos favoritos' if recipe.favorite else 'Favoritar' }}"
            aria-pressed="{{ 'true' if recipe.favorite else 'false' }}">
            {{ '♥' if recipe.favorite else '♡' }}
          </button>
        </div>
        <div class="pin-info">
          <h3>{{ recipe.title }}</h3>
          <p>{{ recipe.description }}</p>
        </div>
      </article>
    {% endfor %}
  </div>
  {% else %}
    <div class="empty-state">
      {% if showing_favorites %}
        <p>Você ainda não marcou favoritos. Clique no coração de uma receita para vê-la aqui.</p>
      {% else %}
        <p>Ainda não temos receitas cadastradas. Clique em "Cadastrar Receita" no topo para adicionar a primeira delícia!</p>
      {% endif %}
    </div>
  {% endif %}
</section>

<div class="modal" id="recipe-modal" aria-hidden="true" role="dialog">
  <div class="modal-backdrop" data-close></div>
  <div class="modal-dialog" role="document">
    <button class="modal-close" type="button" data-close aria-label="Fechar">✕</button>
    <div class="modal-media">
      <img id="modal-image" src="" alt="Visual da receita">
    </div>
    <div class="modal-body">
      <p class="eyebrow">Receita</p>
      <h2 id="modal-title"></h2>
      <p id="modal-description" class="lead"></p>
      <h3>Ingredientes</h3>
      <ul id="modal-ingredients"></ul>
      <h3>Modo de Preparo</h3>
      <ol id="modal-instructions"></ol>
      <div class="modal-actions">
        <a class="btn ghost" id="edit-link" href="#">Atualizar História</a>
        <form id="delete-form" method="post" action="#">
          <button type="submit" class="btn danger">Deletar Receita</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('recipe-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalDesc = document.getElementById('modal-description');
  const modalImg = document.getElementById('modal-image');
  const modalIngredients = document.getElementById('modal-ingredients');
  const modalInstructions = document.getElementById('modal-instructions');
  const editLink = document.getElementById('edit-link');
  const deleteForm = document.getElementById('delete-form');
  const favoritesOnly = new URLSearchParams(window.location.search).get('favorites') === '1';

  function renderEmptyFavoritesStateIfNeeded() {
    const grid = document.querySelector('.pin-grid');
    if (favoritesOnly && grid && grid.children.length === 0) {
      const gallery = document.querySelector('.gallery');
      gallery.innerHTML = '<div class="empty-state"><p>Você ainda não marcou favoritos. Clique no coração de uma receita para vê-la aqui.</p></div>';
    }
  }

  function closeModal() {
    modal.setAttribute('aria-hidden', 'true');
    modal.classList.remove('open');
  }

  function openModal(card) {
    const { id, title, description, image } = card.dataset;
    const ingredients = JSON.parse(card.dataset.ingredients || '[]');
    const instructions = JSON.parse(card.dataset.instructions || '[]');

    modalTitle.textContent = title;
    modalDesc.textContent = description;
    modalImg.src = image;
    modalImg.alt = title;

    modalIngredients.innerHTML = '';
    ingredients.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      modalIngredients.appendChild(li);
    });

    modalInstructions.innerHTML = '';
    instructions.forEach(step => {
      const li = document.createElement('li');
      li.textContent = step;
      modalInstructions.appendChild(li);
    });

    editLink.href = `${card.dataset.id ? '/cadastrar?recipe_id=' + card.dataset.id : '#'}`;
    deleteForm.action = `/recipes/${card.dataset.id}/delete`;

    modal.setAttribute('aria-hidden', 'false');
    modal.classList.add('open');
  }

  document.querySelectorAll('.pin-card').forEach(card => {
    card.addEventListener('click', () => openModal(card));
    card.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        openModal(card);
      }
    });
  });

  function updateFavoriteButton(button, isFavorite) {
    button.classList.toggle('is-favorite', isFavorite);
    button.setAttribute('aria-pressed', isFavorite.toString());
    button.setAttribute('aria-label', isFavorite ? 'Remover dos favoritos' : 'Favoritar');
    button.textContent = isFavorite ? '♥' : '♡';
  }

  document.querySelectorAll('.pin-fav').forEach(button => {
    const card = button.closest('.pin-card');
    const recipeId = card.dataset.id;

    button.addEventListener('click', (event) => {
      event.stopPropagation();
      const nextFavoriteState = card.dataset.favorite !== 'true';

      fetch(`/api/recipes/${recipeId}/favorite`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ favorite: nextFavoriteState })
      })
        .then((res) => {
          if (!res.ok) {
            throw new Error('Erro ao atualizar favorito');
          }
          return res.json();
        })
        .then((data) => {
          const isFavorite = !!data.favorite;
          card.dataset.favorite = isFavorite.toString();
          updateFavoriteButton(button, isFavorite);

          if (favoritesOnly && !isFavorite) {
            card.remove();
            renderEmptyFavoritesStateIfNeeded();
          }
        })
        .catch(() => {
          alert('Não foi possível atualizar o favorito agora. Tente novamente.');
        });
    });

    updateFavoriteButton(button, card.dataset.favorite === 'true');
  });

  renderEmptyFavoritesStateIfNeeded();

  document.querySelectorAll('[data-close]').forEach(el => {
    el.addEventListener('click', closeModal);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
    }
  });
</script>
{% endblock %}
